<div class="p-6">
  <div class="page-header">
    <h1 class="text-3xl font-bold mb-2" *ngIf="isEditMode">Modifier avoir</h1>
    <h1 class="text-3xl font-bold mb-2" *ngIf="!isEditMode">Nouvel avoir</h1>
    <div class="page-info">
      <mat-icon class="page-icon">{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
      <span class="page-text">{{ isEditMode ? "Modifier les informations de l'avoir" : "Ajouter un nouvel avoir" }}</span>
    </div>
  </div>

  <mat-card class="max-w-2xl mx-auto">
    <div class="p-6">
      <!-- Message d'erreur -->
      <div class="error-message" *ngIf="errorMessage">
        <mat-icon class="error-icon">error</mat-icon>
        <span class="error-text">{{ errorMessage }}</span>
        <button mat-icon-button class="error-close" (click)="errorMessage = null">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="creditNoteForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Informations générales -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">Informations générales</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <mat-form-field appearance="outline">
              <mat-label>Numéro avoir *</mat-label>
              <input matInput formControlName="creditNoteNumber" placeholder="Numéro d'avoir">
              <mat-error *ngIf="creditNoteForm.get('creditNoteNumber')?.hasError('required')">
                Le numéro est requis
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Facture associée *</mat-label>
              <input matInput 
                     placeholder="Rechercher par numéro de facture..."
                     (keyup)="filterInvoices($event)"
                     #invoiceSearch>
              <mat-select formControlName="invoiceId" (selectionChange)="onInvoiceSelected()">
                <mat-option value="">Sélectionner une facture</mat-option>
                <mat-option *ngFor="let invoice of filteredInvoices" [value]="invoice.id">
                  {{ invoice.invoiceNumber }} - {{ invoice.supplier.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="creditNoteForm.get('invoiceId')?.hasError('required')">
                La facture est requise
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date avoir *</mat-label>
              <input matInput 
                     [matDatepicker]="creditDatePicker" 
                     formControlName="creditDate"
                     readonly>
              <mat-datepicker-toggle matSuffix [for]="creditDatePicker">
                <mat-icon>calendar_today</mat-icon>
              </mat-datepicker-toggle>
              <mat-datepicker #creditDatePicker></mat-datepicker>
              <mat-error *ngIf="creditNoteForm.get('creditDate')?.hasError('required')">
                La date est requise
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Montant *</mat-label>
              <input matInput 
                     type="number"
                     step="0.01"
                     formControlName="amount" 
                     placeholder="0.00">
              <mat-error *ngIf="creditNoteForm.get('amount')?.hasError('required')">
                Le montant est requis
              </mat-error>
              <mat-error *ngIf="creditNoteForm.get('amount')?.hasError('min')">
                Le montant doit être positif
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Motif -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">Motif de l'avoir</h3>
          <mat-form-field appearance="outline">
            <mat-label>Motif</mat-label>
            <textarea matInput 
                      formControlName="reason" 
                      rows="4"
                      placeholder="Expliquez la raison de cet avoir...">
            </textarea>
          </mat-form-field>
        </div>

        <!-- Actions -->
        <div class="flex justify-between">
          <button mat-stroked-button 
                  type="button" 
                  routerLink="/credit-notes"
                  [disabled]="isLoading">
            Annuler
          </button>
          <div class="space-x-4">
            <button mat-raised-button 
                    color="primary" 
                    type="submit"
                    [disabled]="creditNoteForm.invalid || isLoading">
              <span *ngIf="!isLoading">{{ isEditMode ? "Mettre à jour" : "Enregistrer" }}</span>
              <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
            </button>
          </div>
        </div>
      </form>
    </div>
  </mat-card>
</div>
